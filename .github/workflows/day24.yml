name: Advanced Day24 Pipeline

on:
 push:
   branches: [ main ]

jobs:

 build:

   runs-on: ubuntu-latest

   steps:

   - name: Checkout Code
     uses: actions/checkout@v3

   - name: Setup Node
     uses: actions/setup-node@v3
     with:
       node-version: 18

   - name: Install Dependencies
     run: npm install

   - name: Build Docker Image
     run: docker build -t todo-app:${{ github.sha }} .

   - name: Upload Artifact
     uses: actions/upload-artifact@v4
     with:
       name: project-files
       path: .

 test:

   needs: build

   runs-on: ubuntu-latest

   steps:

   - uses: actions/checkout@v3

   - name: Run Tests
     run: npm test


 security-scan:

   needs: test

   runs-on: ubuntu-latest

   steps:

   - name: Checkout Code
     uses: actions/checkout@v3

   - name: Install Trivy
     run: |
       sudo apt-get update
       sudo apt-get install wget apt-transport-https gnupg -y
       wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
       echo "deb https://aquasecurity.github.io/trivy-repo/deb stable main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
       sudo apt-get update
       sudo apt-get install trivy -y

   - name: Scan Docker Image
     run: |
       docker build -t todo-app .
       trivy image todo-app


 deploy:

   needs: security-scan

   runs-on: ubuntu-latest

   steps:

   - name: Deploy Step
     run: echo "Deployment Successful ðŸš€"
